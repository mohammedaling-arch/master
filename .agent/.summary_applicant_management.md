# Applicant Management System - Implementation Summary

## Database Schema Updates

### Applicants Table
Successfully added the following columns:
- `filed_by_staff_id` (INT, NULL) - Tracks which staff member registered the applicant
- `picture_path` (VARCHAR(255), NULL) - Stores path to applicant's profile picture
- `signature_path` (VARCHAR(255), NULL) - Stores path to applicant's signature

### Payments Table
Successfully added:
- `filed_by_staff_id` (INT, NULL) - Tracks which staff member processed the payment

## Backend API Endpoints

### POST /api/applicants (Create)
- **Authentication**: Required (Staff only)
- **File Upload**: Supports `picture` and `signature` via multipart/form-data
- **Request Body (camelCase)**:
  - `firstName` (required)
  - `middleName` (optional)
  - `surname` (required)
  - `gender`, `age`, `email`, `phone`, `address`, `nin` (optional)
- **Auto-populated**: 
  - `filed_by_staff_id` (from authenticated user)
  - `status` = 'active'
  - `picture_path` (from uploaded file)
  - `signature_path` (from uploaded file)

### PUT /api/applicants/:id (Update)
- **Authentication**: Required (Staff only)
- **File Upload**: Supports `picture` and `signature` via multipart/form-data
- **Request Body (snake_case)**:
  - `first_name`, `middle_name`, `surname` (required)
  - `gender`, `age`, `email`, `phone`, `address`, `nin`, `status` (optional)
  - `picture_path`, `signature_path` (existing paths, preserved if no new upload)

### DELETE /api/applicants/:id
- **Validation**: Prevents deletion if applicant has associated affidavits or probate applications

## Frontend Implementation

### ApplicantManager Component
Location: `client/src/components/staff/ApplicantManager.jsx`

#### Key Features:
1. **Add Applicant**: Modal form with file upload support
2. **Edit Applicant**: Pre-fills existing data, allows file replacement
3. **Delete Applicant**: Confirmation modal with validation
4. **Search/Filter**: Real-time search across applicant data
5. **Image Display**: Corrected URL paths to properly display uploaded images

#### Form Handling:
- **Create Mode**: Maps state properties to camelCase for backend (firstName, middleName)
- **Edit Mode**: Maps state properties to snake_case for backend (first_name, middle_name)
- **File Uploads**: Only appends File objects, preserves existing paths when not updating
- **Empty Age Handling**: Converts empty string to 0 to prevent SQL errors

#### Image Path Correction:
```javascript
// Fixed to strip /api from base URL since uploads are served at root
src={`${api.defaults.baseURL.replace(/\/api$/, '')}${row.picture_path}`}
```

## Staff Workload Tracking

### Modified Endpoints:

#### GET /api/staff/jurat/stats
Now calculates:
- `total_applicants`: Count from `applicants` table WHERE `filed_by_staff_id` = current staff
- `total_fees`: Sum from `payments` table WHERE `filed_by_staff_id` = current staff
- Staff-specific affidavit and probate counts via JOIN with payments table

#### GET /api/staff/jurat/affidavits
Filters affidavits to show only those associated with payments filed by the logged-in staff member.

#### GET /api/staff/jurat/probate
Filters probate applications similarly.

#### GET /api/staff/jurat/payments
New endpoint to fetch payments processed by the logged-in staff member.

## File Upload Configuration

### Multer Setup
```javascript
const storage = multer.diskStorage({
    destination: './uploads/',
    filename: (req, file, cb) => {
        cb(null, `${Date.now()}-${file.originalname}`);
    }
});
```

### Static File Serving
```javascript
app.use('/uploads', express.static(path.join(__dirname, 'uploads'), {
    setHeaders: (res) => {
        res.set('Access-Control-Allow-Origin', '*');
    }
}));
```

## Testing Checklist

- [x] Database schema updated with all required columns
- [x] Backend POST endpoint creates applicants with filed_by_staff_id
- [x] Backend PUT endpoint updates applicants correctly
- [x] Frontend correctly maps field names (camelCase vs snake_case)
- [x] File uploads handled properly (picture and signature)
- [x] Image paths display correctly in UI
- [x] Empty age values handled (converted to 0)
- [x] Staff workload stats reflect individual performance
- [ ] End-to-end test: Add new applicant with files
- [ ] End-to-end test: Edit existing applicant and update files
- [ ] End-to-end test: Verify images display correctly after upload

## Known Issues & Resolutions

1. **Image Path Issue**: Fixed by stripping `/api` from base URL
2. **Empty Age Error**: Fixed by converting empty string to 0
3. **Database Schema**: All columns added successfully with correct credentials
4. **Field Name Mapping**: Correctly handles camelCase (POST) vs snake_case (PUT)

## Next Steps

1. Test the complete add/edit workflow in the UI
2. Verify file uploads are saved correctly to `/uploads` directory
3. Confirm images display properly in the applicant list
4. Test staff workload stats accuracy
5. Verify payment tracking by staff member
